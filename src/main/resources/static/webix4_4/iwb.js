var iwb = { ui: {} };
var iwbSvgLogo =
  '<svg version="1.1" id="black_logo" class="white-logo standard-logo middle-content" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="200px" height="42px" viewBox="0 0 896.587 202.576" enable-background="new 0 0 896.587 202.576" xml:space="preserve" style="display: block; margin-top:-4px;"> <g> <g> <path fill="#FFFFFF" d="M316.929,105.205h6.132v7.268h-6.132V105.205z M323.061,155.099h-6.132v-36.128h6.132V155.099z"></path> <polygon fill="#FFFFFF" points="380.188,155.1 368.43,113.171 368.286,113.171 356.384,155.1 349.244,155.1 336.043,105.205 343.04,105.205 353.138,146.714 353.283,146.714 364.824,105.205 372.253,105.205 383.65,146.714 383.795,146.714 394.253,105.205 401.106,105.205 387.329,155.1"></polygon> <path fill="#FFFFFF" d="M413.476,120.334c1.033-3.145,2.585-5.928,4.652-8.351c2.067-2.422,4.64-4.355,7.719-5.8 c3.077-1.443,6.659-2.167,10.747-2.167c4.087,0,7.67,0.724,10.748,2.167c3.076,1.444,5.65,3.378,7.718,5.8 c2.067,2.423,3.618,5.206,4.653,8.351c1.033,3.145,1.551,6.417,1.551,9.818s-0.518,6.673-1.551,9.817 c-1.035,3.146-2.586,5.93-4.653,8.352s-4.642,4.344-7.718,5.765c-3.078,1.42-6.661,2.132-10.748,2.132 c-4.088,0-7.67-0.712-10.747-2.132c-3.079-1.421-5.651-3.343-7.719-5.765s-3.619-5.206-4.652-8.352 c-1.034-3.145-1.551-6.416-1.551-9.817S412.442,123.479,413.476,120.334 M419.788,137.595c0.674,2.446,1.731,4.647,3.175,6.603 c1.442,1.958,3.293,3.529,5.554,4.718c2.26,1.188,4.952,1.781,8.078,1.781s5.818-0.594,8.079-1.781 c2.261-1.188,4.112-2.76,5.555-4.718c1.442-1.955,2.5-4.156,3.174-6.603c0.672-2.446,1.01-4.927,1.01-7.442 s-0.338-4.997-1.01-7.442c-0.674-2.446-1.731-4.646-3.174-6.604c-1.442-1.956-3.294-3.528-5.555-4.716 c-2.261-1.188-4.953-1.782-8.079-1.782s-5.818,0.594-8.078,1.782c-2.261,1.188-4.111,2.76-5.554,4.716 c-1.443,1.958-2.501,4.158-3.175,6.604c-0.674,2.445-1.009,4.927-1.009,7.442S419.114,135.148,419.788,137.595"></path> <path fill="#FFFFFF" d="M501.081,105.205c4.904,0,8.739,1.164,11.505,3.493c2.765,2.33,4.146,5.521,4.146,9.574 c0,3.028-0.709,5.685-2.128,7.966c-1.418,2.283-3.689,3.844-6.815,4.683v0.14c1.49,0.279,2.705,0.746,3.643,1.397 c0.938,0.653,1.683,1.433,2.236,2.341c0.552,0.908,0.961,1.922,1.226,3.04c0.264,1.118,0.469,2.283,0.613,3.494 c0.096,1.212,0.168,2.445,0.217,3.703c0.047,1.259,0.168,2.494,0.36,3.704c0.192,1.212,0.469,2.365,0.83,3.459 c0.36,1.095,0.901,2.062,1.622,2.9h-7.646c-0.481-0.513-0.806-1.211-0.974-2.097c-0.17-0.884-0.277-1.874-0.324-2.97 c-0.049-1.095-0.098-2.271-0.145-3.528c-0.048-1.259-0.192-2.492-0.433-3.704c-0.193-1.211-0.433-2.364-0.722-3.46 c-0.289-1.094-0.746-2.049-1.37-2.864c-0.626-0.814-1.443-1.469-2.453-1.957c-1.009-0.489-2.356-0.733-4.039-0.733h-16.734V155.1 h-6.853v-49.895H501.081z M502.523,127.846c1.442-0.232,2.705-0.687,3.787-1.363c1.081-0.674,1.947-1.583,2.597-2.725 c0.649-1.141,0.973-2.621,0.973-4.438c0-2.516-0.721-4.564-2.163-6.149c-1.442-1.583-3.776-2.376-6.996-2.376h-17.023v17.4h14.282 C499.566,128.195,501.081,128.08,502.523,127.846"></path> <polygon fill="#FFFFFF" points="540.319,105.205 540.319,130.082 566.432,105.205 575.303,105.205 553.592,125.331 576.169,155.1 567.513,155.1 548.904,129.872 540.319,137.629 540.319,155.1 533.466,155.1 533.466,105.205"></polygon> <path fill="#FFFFFF" d="M607.474,105.205c1.105,0,2.297,0.012,3.57,0.034c1.273,0.024,2.535,0.095,3.787,0.21 c1.25,0.117,2.416,0.292,3.498,0.524c1.082,0.233,2.008,0.583,2.777,1.048c1.684,0.979,3.113,2.331,4.293,4.053 c1.176,1.725,1.766,3.844,1.766,6.36c0,2.654-0.66,4.949-1.982,6.883c-1.324,1.933-3.211,3.366-5.662,4.298v0.14 c3.174,0.652,5.602,2.05,7.285,4.192c1.682,2.144,2.523,4.752,2.523,7.826c0,1.817-0.338,3.589-1.01,5.312 c-0.674,1.724-1.67,3.249-2.992,4.577c-1.322,1.327-2.959,2.4-4.906,3.215c-1.947,0.815-4.195,1.223-6.744,1.223h-24.885v-49.895 H607.474z M609.349,126.658c3.896,0,6.695-0.664,8.404-1.992c1.707-1.327,2.561-3.319,2.561-5.975c0-1.77-0.289-3.167-0.865-4.192 c-0.578-1.024-1.371-1.816-2.379-2.377c-1.012-0.559-2.178-0.918-3.5-1.083c-1.324-0.162-2.73-0.244-4.221-0.244h-13.705v15.863 H609.349z M612.812,149.509c3.029,0,5.398-0.792,7.105-2.377c1.705-1.582,2.561-3.772,2.561-6.567c0-1.63-0.312-2.98-0.938-4.054 c-0.627-1.07-1.455-1.922-2.488-2.55c-1.035-0.629-2.227-1.072-3.57-1.327c-1.348-0.257-2.742-0.386-4.186-0.386h-15.652v17.261 H612.812z"></path> <polygon fill="#FFFFFF" points="680.976,105.205 680.976,110.795 652.267,110.795 652.267,126.658 679.028,126.658 679.028,132.248 652.267,132.248 652.267,149.509 681.192,149.509 681.192,155.1 645.415,155.1 645.415,105.205"></polygon> <polygon fill="#FFFFFF" points="691.218,110.795 691.218,105.205 732.405,105.205 732.405,110.795 715.237,110.795 715.237,155.1 708.386,155.1 708.386,110.795"></polygon> <polygon fill="#FFFFFF" points="739.835,110.795 739.835,105.205 781.021,105.205 781.021,110.795 763.854,110.795 763.854,155.1 757.001,155.1 757.001,110.795"></polygon> <polygon fill="#FFFFFF" points="829.493,105.205 829.493,110.795 800.784,110.795 800.784,126.658 827.546,126.658 827.546,132.248 800.784,132.248 800.784,149.509 829.71,149.509 829.71,155.1 793.933,155.1 793.933,105.205"></polygon> <path fill="#FFFFFF" d="M869.454,105.205c4.904,0,8.738,1.164,11.504,3.493c2.766,2.33,4.148,5.521,4.148,9.574 c0,3.028-0.711,5.685-2.129,7.966c-1.418,2.283-3.689,3.844-6.816,4.683v0.14c1.49,0.279,2.705,0.746,3.643,1.397 c0.938,0.653,1.684,1.433,2.236,2.341s0.963,1.922,1.227,3.04s0.469,2.283,0.613,3.494c0.096,1.212,0.168,2.445,0.217,3.703 c0.047,1.259,0.168,2.494,0.359,3.704c0.193,1.212,0.469,2.365,0.83,3.459c0.361,1.095,0.902,2.062,1.623,2.9h-7.645 c-0.482-0.513-0.807-1.211-0.975-2.097c-0.17-0.884-0.277-1.874-0.324-2.97c-0.049-1.095-0.098-2.271-0.145-3.528 c-0.049-1.259-0.191-2.492-0.434-3.704c-0.191-1.211-0.432-2.364-0.721-3.46c-0.289-1.094-0.746-2.049-1.371-2.864 c-0.625-0.814-1.443-1.469-2.451-1.957c-1.01-0.489-2.357-0.733-4.041-0.733h-16.734V155.1h-6.852v-49.895H869.454z M870.896,127.846c1.443-0.232,2.705-0.687,3.787-1.363c1.082-0.674,1.947-1.583,2.598-2.725c0.648-1.141,0.973-2.621,0.973-4.438 c0-2.516-0.721-4.564-2.164-6.149c-1.441-1.583-3.775-2.376-6.996-2.376h-17.023v17.4h14.283 C867.938,128.195,869.454,128.08,870.896,127.846"></path> </g> <g> <path fill="#FFFFFF" d="M46.536,31.08c0,10.178-8.251,18.429-18.429,18.429c-10.179,0-18.429-8.251-18.429-18.429 c0-10.179,8.25-18.43,18.429-18.43C38.284,12.65,46.536,20.901,46.536,31.08"></path> <path fill="#FFFFFF" d="M220.043,62.603c-0.859,0-1.696,0.082-2.542,0.128c-0.222-0.007-0.429-0.065-0.654-0.065 c-0.674,0-1.314,0.128-1.969,0.198c-0.032,0.003-0.064,0.003-0.096,0.005v0.005c-9.241,1.04-16.451,8.79-16.451,18.309 c0,9.555,7.263,17.326,16.554,18.319c0,0.03,0,0.063,0,0.094c0.482,0.027,0.953,0.035,1.428,0.05 c0.182,0.006,0.351,0.055,0.534,0.055c0.088,0,0.17-0.025,0.258-0.026c0.96,0.02,1.927,0.026,2.938,0.026 c16.543,0,29.956,13.021,29.956,29.564c0,16.545-13.412,29.956-29.956,29.956c-15.521,0-28.283-11.804-29.803-26.924V24.547 h-0.054c-0.289-9.926-8.379-17.896-18.375-17.896c-9.995,0-18.086,7.971-18.375,17.896h-0.053v118.529 c0,10.175,11.796,52.85,66.661,52.85c36.815,0,66.661-29.846,66.661-66.662C286.704,92.448,256.858,62.603,220.043,62.603"></path> <path fill="#FFFFFF" d="M153.381,143.076h-0.049c-0.805,8.967-8.252,16.021-17.428,16.021s-16.624-7.054-17.428-16.021h-0.048 V76.778h-0.045c-0.245-9.965-8.36-17.979-18.384-17.979s-18.139,8.014-18.384,17.979h-0.045v66.298H81.52 c-0.805,8.967-8.252,16.021-17.428,16.021c-9.176,0-16.624-7.054-17.429-16.021h-0.048V76.778H46.57 C46.324,66.813,38.209,58.8,28.186,58.8c-10.024,0-18.139,8.014-18.384,17.979H9.756v66.298 c0.836,29.321,24.811,52.849,54.335,52.849c13.79,0,26.33-5.178,35.906-13.636c9.577,8.458,22.116,13.636,35.906,13.636 c14.604,0,27.85-5.759,37.61-15.128C157.748,167.478,153.381,149.266,153.381,143.076"></path> </g></g></svg>';

if (typeof _localeMsg == "undefined") _localeMsg = {};

function getLocMsg(key) {
  if (key == null) return "";
  var val = _localeMsg[key];
  return val || key;
}

function objProp(o) {
  var t = "";
  for (var q in o)
    t +=
      o[q] instanceof Function
        ? q + " = function{}\n"
        : q + " = " + o[q] + "\n";
  return t;
}
function fmtTimeAgo(a) {
  if (!a) return "-";
  a = Math.round((1 * a) / 1000);
  var d = getLocMsg("seconds");
  if (a > 60) {
    a = Math.round(a / 60);
    d = "minutes";
    if (a > 60) {
      a = Math.round(a / 60);
      d = "hours";
      if (a > 24) {
        a = Math.round(a / 24);
        d = getLocMsg("days");
      } else if (a > 15) {
        return getLocMsg("approx 1 day");
      }
    } else if (a > 40) {
      return getLocMsg("approx 1 hour");
    }
  } else if (a > 40) {
    return getLocMsg("approx 1 minute");
  }
  return a + " " + d + " " + getLocMsg("ago");
}

function fnTblRecEdit(a, b, c) {
  webix.alert(a);
  return false;
}

function mailBoxRenderer(a) {
  return function() {
    return "";
  };
}

function pictureHtml() {
  return "";
}
iwb.request = function(cfg) {
  if (iwb.debug) console.log("iwb.request: " + (cfg ? cfg.url : ""));
  if (!_scd) {
    iwb.checkSession(cfg);
  } else if (cfg && cfg.url) {
    webix
      .ajax()
      .post(cfg.url, cfg.params || {})
      .then(function(result) {
        if (cfg.success)
          try {
            cfg.success(result);
          } catch (e) {
            alert(e);
          }
        else
          try {
            var j = result.json();
            if (j.success !== false) {
              if (cfg.successCallback) cfg.successCallback(j, cfg);
            } else if (cfg.noSuccessCallback) {
              try {
                cfg.successCallback(j, cfg);
              } catch (e) {
                if (iwb.debug)
                  iwb.confirm(
                    "iwb.request.error Expception. Throw?",
                    function() {
                      throw e;
                    }
                  );
              }
            } else
              switch (j.errorType) {
                case "session":
                  iwb.reLogin(cfg);
                  return;
                case "validation":
                  var s = "";
                  if (j.errors)
                    for (var qi = 0; qi < j.errors.length && qi < 3; qi++) {
                      s += j.errors[qi].dsc + ": " + j.errors[qi].msg + "<br/>";
                    }
                  else s = j.error;
                  webix.alert(iwb.strTrim(s, 200), j.errorType || "iWB");
                  return;
                default:
                  if (cfg.error) cfg.error(j, cfg);
                  else iwb.showResponseError(j);
                  return;
              }
          } catch (e) {
            alert(e);
          }
      })
      .fail(function(xhr) {
        var response = JSON.parse(xhr.response);
        webix.message({ type: "error", text: response.error.message });
      });
  }
};

function myHome() {
  var gr1 = {
    x: "xi1-" + _page_tab_id,
    dash: {
      dashId: 16,
      name: "Müşteriler",
      gridId: 3262,
      tableId: 2728,
      is3d: true,
      dtTip: 0,
      graphTip: 3,
      groupBy: "tbl.il",
      funcTip: 0,
      funcFields: "-41",
      queryParams: {},
      legend: true
    }
  };
  var gr2 = {
    x: "xi2-" + _page_tab_id,
    dash: {
      dashId: 3,
      name: "Form by ObjectTip",
      gridId: 21,
      tableId: 40,
      is3d: false,
      dtTip: 2,
      graphTip: 1,
      groupBy: "tbl.object_tip",
      funcTip: 1,
      funcFields: "731",
      queryParams: {
        xform_id: "",
        xdsc: "",
        xmodule_id: "",
        xrender_tip: "",
        xobject_tip: "",
        xobject_id: ""
      }
    }
  };

  var dashLine = {
    height: 146,
    css: "tiles",
    template: function(e) {
      for (
        var t = null, i = e.items, a = "<div class='flex_tmp'>", n = 0;
        n < i.length;
        n++
      )
        (t = i[n]),
          (a += "<div class='item " + t.css + "'>"),
          (a += "<div class='webix_icon icon fa-" + t.icon + "'></div>"),
          (a +=
            "<div class='details'><div class='value'>" +
            t.value +
            "</div><div class='text'>" +
            t.text +
            "</div></div>"),
          (a +=
            "<div class='footer'>Daha fazla <span class='webix_icon fa-angle-double-right'></span></div>"),
          (a += "</div>");
      return (a += "</div>");
    },
    data: {
      items: [
        {
          id: 1,
          text: "Toplam Proje",
          value: 459,
          icon: "check-square-o",
          css: "orders"
        },
        {
          id: 4,
          text: "Denetimler",
          value: 40,
          icon: "user",
          css: "users"
        },
        {
          id: 2,
          text: "Sözleşmeler",
          value: 3,
          icon: "quote-right",
          css: "feedbacks"
        },
        {
          id: 3,
          text: "Kurumsal",
          value: "%95",
          icon: "line-chart",
          css: "profit"
        }
      ]
    }
  };

  var graphPie = {
    type: "clean",
    height: 350,
    css: "bg_raised",
    rows: [
      {
        template:
          "<span class='webix_icon fa-pie-chart'></span>Müşterilerin İllere Göre Dağılımı",
        css: "sub_title",
        height: 32
      },
      {
        template:
          '<div id="' + gr1.x + '" style="width:100%;height:100%"></div>',
        on: {
          onAfterRender: function() {
            iwb.dashboard(gr1.dash, gr1.x);
          }
        }
      }
    ]
  };
  var graph1 = {
    type: "clean",
    height: 250,
    css: "bg_raised",
    rows: [
      {
        template:
          "<span class='webix_icon fa-sign-in'></span>Performans Değerlendirmesi",
        css: "sub_title",
        height: 30
      },
      {
        view: "chart",
        type: "stackedArea",
        legend: {
          layout: "x",
          align: "right",
          values: [
            {
              text: "CPI",
              color: "#61b5ee"
            },
            {
              text: "SPI",
              color: "#a4b4bf"
            }
          ]
        },
        offset: 0,
        alpha: 0.8,
        xAxis: {
          template: "#month#"
        },
        radius: 0,
        yAxis: {
          start: 0,
          end: 2e3,
          step: 500
        },
        series: [
          {
            value: "#rec#",
            color: "#a4b4bf"
          },
          {
            value: "#newv#",
            color: "#61b5ee"
          }
        ],
        padding: {
          top: 25
        },
        data: [
          {
            id: 1,
            month: "Jun",
            newv: 300,
            rec: 600
          },
          {
            id: 2,
            month: "Jul",
            newv: 100,
            rec: 400
          },
          {
            id: 3,
            month: "Aug",
            newv: 400,
            rec: 700
          },
          {
            id: 4,
            month: "Sep",
            newv: 600,
            rec: 900
          },
          {
            id: 5,
            month: "Oct",
            newv: 400,
            rec: 400
          }
        ]
      }
    ]
  };
  return {
    type: "clean",
    id: "contentKazim",
    rows: [
      dashLine,
      {
        type: "clean",
        cols: [
          {
            gravity: 3,
            type: "space",
            padding: 10,
            rows: [
              graphPie,
              {
                rows: [
                  {
                    template:
                      "<span class='webix_icon fa-tasks'></span>Bekleyen İşler",
                    type: "header",
                    css: "sub_title",
                    height: 50
                  },
                  {
                    view: "list",
                    css: "tasks_list",
                    autoheight: !0,
                    type: {
                      marker: function(e) {
                        return (
                          "<span class='webix_icon_btn fa-bell-o marker " +
                          e.type +
                          "' style='max-width:32px;' ></span>"
                        );
                      },
                      check: webix.template(
                        '<span class="webix_icon_btn fa-{obj.$check?check-:}square-o list_icon" style="max-width:32px;"></span>'
                      ),
                      template: function(e, t) {
                        return (
                          "<div class='" +
                          (e.$check ? "done" : "") +
                          "'>" +
                          t.check(e, t) +
                          "<span class='list_text'>" +
                          e.text +
                          "</span><span class='marker " +
                          e.type +
                          "'>" +
                          (e.type || "") +
                          "</span></div>"
                        );
                      }
                    },
                    data: [
                      { id: "1", text: "Prepare finance report" },
                      {
                        id: "2",
                        text: "Solex project strategy  meeting",
                        type: "projects"
                      },
                      { id: "3", text: "WestEurope partners call" },
                      {
                        id: "4",
                        text: "Prepare presentation for summer conference",
                        type: "company"
                      },
                      { id: "5", text: "Market research analysis" },
                      { id: "6", text: "Check messages" },
                      {
                        id: "7",
                        text: "Discussing new theme for website",
                        type: "company"
                      }
                    ],
                    on: {
                      onItemClick: function(e) {
                        var t = this.getItem(e);
                        (t.$check = !t.$check), this.refresh(e);
                      }
                    }
                  },
                  {
                    css: "show_all bg",
                    template:
                      "Bütün işleri göster<span class='webix_icon fa-angle-double-right'></span>",
                    height: 40
                  }
                ]
              }
            ]
          },
          {
            gravity: 2.3,
            type: "space",
            padding: 10,
            rows: [
              {
                css: "bg_raised",
                height: 400,
                view: "google-map",
                id: "map",
                key: "AIzaSyAi0oVNVO-e603aUY8SILdD4v9bVBkmiTg",
                zoom: 5,
                center: [39.3671091, 34.7545323]
              },
              graph1
            ]
          }
        ]
      },
      {}
    ]
  };
}

webix.type(webix.ui.tree, {
  name: "menuTree2",
  height: 40,
  icon: function(e) {
    //    	console.log(e);
    for (var t = "", i = "", a = 1; a <= e.$level; a++)
      if (a == e.$level && e.$count) {
        var n = e.open ? "down" : "right";
        t += "<span class='" + i + " webix_icon fa-angle-" + n + "'></span>"; //+"<span class='webix_icon icon fa-cube'></span>"
      }
    return t;
  },
  folder: function(e) {
    //    	console.log(e)
    return e.icon
      ? "<span class='webix_icon icon fa-" + (e.icon || "cube") + "'></span>"
      : "";
  }
});

webix.type(webix.ui.tree, {
  name: "menuTree3",
  height: 40,
  icon: function(e) {
    for (var t = "", i = "", a = 1; a <= e.$level; a++)
      if (a == e.$level && e.$count) {
        var n = e.open ? "down" : "right";
        t += "<span class='" + i + " webix_icon fa-angle-" + n + "'></span>";
      }
    return t;
  },
  folder: function(e) {
    return e.icon
      ? "<span class='webix_icon icon fa-" + e.icon + "'></span>"
      : "";
  }
});

function commentRenderer() {
  return function() {
    return "";
  };
}

function buildParams2(params, map) {
  var bp = "";
  for (var key in params) {
    var newKey = params[key];
    if (typeof newKey == "function") {
      bp += "&" + key + "=" + newKey(params);
    } else if (newKey.charAt(0) == "!")
      bp += "&" + key + "=" + newKey.substring(1);
    else bp += "&" + key + "=" + map[params[key]];
  }
  return bp;
}

function getMasterGridSel(a) {
  if (!a || !a._masterGrid || !$$(a._masterGrid.id).getSelectedItem()) {
    webix.message(getLocMsg("Önce Bir Üst Kayıt Seçiniz ;)"));
    return null;
  } else {
    return $$(a._masterGrid.id).getSelectedItem();
  }
}

function fnRowInsert(g, pk) {
  return function() {
    var href = "showForm?a=2&_fid=" + g.crudFormId;
    if (typeof g._postInsert == "function") {
      var sel = $$(g.id).getSelectedItem();
      href = g._postInsert(sel, href, g); // null donerse acilmayacak
    } else {
      if (g._postInsert) href += "&" + g._postInsert;
    }
    if (href) mainPanel.loadTab({ href: href, id: "crud2-f" + g.crudFormId });
  };
}

function fnRowEdit2(xxx) {
  mainPanel.loadTab({ href: "showForm?a=1&_fid=" + xxx, id: "crud1-f" + xxx });
}

function fnRowDelete(g, pk) {
  return function() {
    var gr = $$(g.id);
    var sel = gr.getSelectedItem();
    if (!sel) {
      webix.alert("Önce Birşeyler Seçmelisiniz");
      return false;
    }
    console.log(sel);
    webix.confirm("Seçili kaydı Silmek istediğinden emin misiniz?", function(
      ax
    ) {
      if (ax)
        webix
          .ajax()
          .post(
            "ajaxPosstForm?a=3&_fid=" + g.crudFormId + buildParams2(pk, sel),
            function(a, b, x) {
              console.log(a);
              console.log(b);
              console.log(c);
            }
          );
    });
  };
}

function fnRowDelete2(xxx) {
  webix.confirm("Silmek istediğinizden emin misiniz?", function(ax) {
    if (ax)
      webix.ajax().post("ajaxPostForm?a=3&_fid=" + xxx, function(a, b, x) {
        webix.alert("Silindi");
      });
  });
}

function showFiles(t, k, z) {
  var ee = webix.ui({
    view: "popup",
    autowidth: !0,
    position: z ? undefined : "center",
    padding: 0,
    //		css: "list_popup",
    body: {
      type: "clean",
      borderless: !0,
      rows: [
        {
          view: "list",
          autoheight: !0,
          url:
            "ajaxQueryData?_qid=806&_renderer=webix3_3&_tableId=" +
            t +
            "&_tablePk=" +
            k,
          type: {
            template:
              "<a href='dl/#value#?_fai=#id#' target=_blank><span class='webix_icon fa-download'></span>&nbsp;#value#</a>"
          }
        },
        { height: 1, css: { "background-color": "lightgray" } },
        {
          view: "uploader",
          label: "Dosya Yükle",
          upload:
            "upload2.form?profilePictureFlag=0&table_id=" + t + "&table_pk=" + k
        }
        //			,{height:32,template: "<a href=# onclick='return attachFiles("+t+","+k+")'>&nbsp;Upload New Files ...</a>"}
      ]
    }
  });
  if (z) ee.show(z);
  else ee.show();
  return false;
}

function attachFiles(t, k, z) {
  var ee = webix.ui({
    view: "popup",
    position: z ? undefined : "center",
    autowidth: !0,
    padding: 0,
    body: {
      view: "uploader",
      label: "Dosya Yükle",
      upload:
        "upload2.form?profilePictureFlag=0&table_id=" + t + "&table_pk=" + k
    }
  });
  if (z) ee.show(z);
  else ee.show();
  return false;
}

function fileAttachmentHtmlOld(x, y, z, g) {
  return x && 1 * x
    ? '<span style="cursor:pointer;" class="webix_icon fa-upload hi-highlight hi-highlight-orange" onClick="showFiles(' +
        g.crudTableId +
        "," +
        z.data[g.idField] +
        ',this)"></span>'
    : '<span style="cursor:pointer;color:lightgray" class="webix_icon fa-download" onClick="attachFiles(' +
        g.crudTableId +
        "," +
        z.data[g.idField] +
        ')"></span>';
}
function fileAttachmentHtml(x, y, z, g) {
  return x && 1 * x
    ? '<span style="cursor:pointer;font-weight:bold;padding: 2px 4px;border-radius:50%;background-color:#969696;color:white;" class="status" onClick="showFiles(' +
        g.crudTableId +
        "," +
        z.data[g.idField] +
        ',this)">&nbsp;' +
        x +
        "&nbsp;</span>"
    : '<span style="cursor:pointer;color:lightgray" class="webix_icon fa-upload" onClick="showFiles(' +
        g.crudTableId +
        "," +
        z.data[g.idField] +
        ',this)"></span>';
}

function vcsHtml(x) {
  // 0: exclude, 1:edit, 2:insert, 3:delete, 9:synched
  if (x) {
    x = x.split(",");
    if (1 * x[0] != 9)
      return (
        '<img alt="' +
        x[1] +
        '" src="../images/custom/vcs' +
        x[0] +
        '.png" border=0>'
      );
    else return x[1];
  }
}

function disabledCheckBoxHtml(f) {
  return function(x) {
    return (
      '<img src="../images/custom/' +
      (x && x[f] ? "" : "un") +
      'checked.gif" border=0>'
    );
  };
}

function refreshMainGrid(g, sf) {
  return function() {
    var gg = $$(g.id);
    gg.clearAll();
    gg.load(g._url + (sf ? "&" + iwb.map2str(getValues(sf)) : ""));
  };
}

function fnRowEdit(g, pk) {
  return function(ax) {
    var gr = $$(g.id);
    var sel = gr.getItem(ax); //gr.getSelectedItem();
    var param = buildParams2(pk, sel);
    var href = "showForm?a=1&_fid=" + g.crudFormId + param;
    if (typeof g._postUpdate == "function") {
      var sel = $$(g.id).getSelectedItem();
      href = g._postUpdate(sel, href, g); // null donerse acilmayacak
    } else {
      if (g._postUpdate) href += "&" + g._postUpdate;
    }

    if (href)
      mainPanel.loadTab({
        href: href,
        id: "crud1-f" + g.crudFormId + "-" + param
      });
  };
}

function prepareCrudButtons(g, pk) {
  var r = [];
  if (!g.crudFlags) return r; //{view:"button",css:"button_primary button_raised",type:"iconButton",icon:"plus",label:"Add order",width:150,
  if (g.crudFlags.insert)
    r.push({
      view: "button",
      tooltip: "NEW RECORD",
      css: "button_primary button_raised",
      type: "iconButton",
      icon: "plus",
      label: "NEW RECORD",
      click: fnRowInsert(g, pk),
      width: 155
    });
  if (g.crudFlags.edit) {
    //		g.columns.push({header:' ', id: '_edit', width: 40, template:function(ax){return '<span onclick="fnRowEdit2(\''+g.crudFormId+buildParams2(pk, ax)+'\')" style="cursor:pointer;" class="webix_icon fa-pencil hi-highlight hi-highlight-red"></span>'}});
    if (g._postUpdateButton !== false)
      g.columns.push({
        header: " ",
        id: "_edit",
        width: 40,
        template:
          g._postUpdateButton ||
          function(ax) {
            return (
              "<span onclick=\"fnRowEdit2('" +
              g.crudFormId +
              buildParams2(pk, ax) +
              '\')" style="cursor:pointer;" class="webix_icon fa-pencil hi-highlight hi-highlight-red"></span>'
            );
          }
      });
    if (!g.on) g.on = {};
    //		g.on.onItemDblClick=function(ax){fnRowEdit2(g.crudFormId+buildParams2(pk, this.getItem(ax)));};
    g.on.onItemDblClick = fnRowEdit(g, pk); //function(ax){fnRowEdit2(g.crudFormId+buildParams2(pk, this.getItem(ax)));};
    //	r.push({ view:"button", tooltip:'Update', type: "icon", icon: "edit", value:"Update", click: fnRowEdit(g, pk), width: 30});
  }
  if (g.crudFlags.remove) {
    g.columns.push({
      header: " ",
      id: "_del",
      width: 50,
      template: function(ax) {
        return (
          "<span onclick=\"fnRowDelete2('" +
          g.crudFormId +
          buildParams2(pk, ax) +
          '\')" style="cursor:pointer;" class="webix_icon fa-trash-o hi-highlight hi-highlight-red"></span>'
        );
      }
    });
    //	r.push({ view:"button", tooltip:'Delete', type: "icon", icon: "trash" , click: fnRowDelete(g, pk),width: 30});
  } //if(g.crudFlags.ximport)
  /*	if(g.crudFlags.xcopy)r.push({ view:"button", tooltip:'Copy', type: "icon", icon: "copy" , click: function(){alert('TODO')},width: 30});
	if(g.crudFlags.ximport)r.push({ view:"button", tooltip:'Import', type: "icon", icon: "shirtsinbulk" , click: function(){alert('TODO')},width: 30});
*/ return r;
}

function fncBI(g, showMasterDetailReport) {
  return function() {
    openPopup(
      "showPage?_tid=" +
        (g.crudTableId
          ? "1200&xtable_id=" + g.crudTableId
          : "2395&xquery_id=" + g.queryId),
      "_blank",
      1200,
      800,
      1
    );
  };
}

function fncGridMap(g) {
  return function() {
    //		openPopup('showPage?_tid=1200&xtable_id=' + g.crudTableId, '_blank', 1200, 800, 1);
  };
}

var subMenus1 = [
  { id: 10, value: "count" },
  { id: 11, value: "sum" },
  { id: 12, value: "avg" },
  { id: 13, value: "max" },
  { id: 14, value: "min" }
];

function addTab4GridWSearchFormWithDetailGrids(obj) {
  var masterGrid = obj.grid;
  var pageRows = [],
    searchForm = null;
  //	if(masterGrid.searchForm)pageRows.push(searchForm=masterGrid.searchForm.render());
  var buttons = [];
  var r = prepareCrudButtons(masterGrid, masterGrid.pk || obj.pk);
  if (r && r.length) buttons = buttons.concat(r);
  if (masterGrid.extraButtons)
    buttons = buttons.concat(masterGrid.extraButtons);
  buttons.push({
    view: "button",
    css: "button_primary",
    type: "iconButton",
    icon: "refresh",
    /*label:'RELOAD', */ width: 50,
    click: refreshMainGrid(masterGrid, searchForm)
  });
  buttons.push({}); //,{view:"button", tooltip:'Diğer', css:"button_primary",type:"iconButton", icon: "chevron-down", label:"", click: false, width: 50}
  buttons.push({
    view: "pager",
    css: { "text-align": "right" },
    id: "pagerA-" + masterGrid.id,
    template: "{common.pages()}",
    autosize: !0,
    height: 35,
    group: 5
  });
  //    buttons.push({view:"toolbar",css:"highlighted_header header6",paddingX:5,paddingY:5,height:40,cols:[{view:"pager",id:"pagerA",template:"{common.pages()}",autosize:!0,height:35,group:5}]});
  masterGrid.pager = "pagerA-" + masterGrid.id;
  buttons.push({
    view: "button",
    css: "button_danger",
    type: "iconButton",
    icon: "file-pdf-o",
    width: 120,
    label: "Export",
    click: function() {
      webix.toExcel($$(masterGrid.id));
    }
  });

  buttons.push({
    view: "button",
    css: "button_danger",
    type: "iconButton",
    icon: "area-chart",
    width: 90,
    label: "BI",
    click: fncBI(masterGrid, false)
  });

  setTimeout(function() {
    var selectedColumnIndex = -1;
    webix.event($$(masterGrid.id).$view, "contextmenu", function(e) {
      var grid = $$(masterGrid.id);
      var pos = grid.locate(e);

      if (pos && !pos.row) {
        selectedColumnIndex = pos.cind;
        var columns = webix.toArray(grid.config.columns);
        //				console.log('aaaa',columns[selectedColumnIndex])
        $$("col-cmenu2" + masterGrid.id).show(e);
      } else selectedColumnIndex = -1;
    });

    $$(masterGrid.id).$view.oncontextmenu = function() {
      return false;
    };
    var cmenu = [{ id: 2, value: "Graphic" }]; //,{id:5,value:"Group By"}
    if (masterGrid.$mapQueryField || masterGrid.$mapQueryFieldName)
      cmenu.unshift({ id: 6, value: "Map", submenu: subMenus1 });

    webix.ui({
      view: "contextmenu",
      id: "col-cmenu2" + masterGrid.id,
      width: 250,
      data: cmenu,
      on: {
        onMenuItemClick: function(id) {
          if (selectedColumnIndex < 0) return;
          id = 1 * id;
          var grid = $$(masterGrid.id);
          var columns = webix.toArray(grid.config.columns);
          var stat = 0;
          masterGrid._lastGraph = false;
          if (id >= 10 && id < 15) {
            //					      masterGrid._stat=id-10;masterGrid._field=columns[selectedColumnIndex].id;
            webix.$$("aggr-" + masterGrid.id).setValue(id);
            webix
              .$$("qfield-" + masterGrid.id)
              .setValue(columns[selectedColumnIndex].id);
            webix.$$("graph-" + masterGrid.id).setValue(9);
            $$("mymultiview" + masterGrid.id).setValue(
              "idMapView" + masterGrid.id
            );
            return;
          }
          switch (1 * id) {
            case 2:
              webix.$$("graph-" + masterGrid.id).setValue(3);
              webix
                .$$("group-" + masterGrid.id)
                .setValue(columns[selectedColumnIndex].id);
              $$("mymultiview" + masterGrid.id).setValue(
                "idMapView" + masterGrid.id
              );
              break;
            //  case	5:columnGroupBy(columns[columnIndex]);break;
          }
          selectedColumnIndex = -1;
        }
      }
    });
  }, 1000);
  if (masterGrid.$mapQueryField || masterGrid.$mapQueryFieldName) {
    buttons.push({
      view: "button",
      css: "button_primary",
      type: "iconButton",
      icon: "globe",
      width: 95,
      label: "Map",
      click: function() {
        webix.$$("aggr-" + masterGrid.id).setValue(10);
        webix.$$("graph-" + masterGrid.id).setValue(9);
        $$("mymultiview" + masterGrid.id).setValue("idMapView" + masterGrid.id);
      }
    });
  }

  //buttons.push({}, { view:"button", tooltip:'Settings', type: "icon", icon: "wrench", value:"Info", width:30, align:"right" });
  //	pageRows.push({view:"toolbar", id:"gt-"+masterGrid.id, css: "highlighted_header header2", height:33, cols:buttons});
  pageRows.push({
    type: "clean",
    id: "gt-" + masterGrid.id,
    height: 42,
    cols: buttons
  });
  masterGrid.css = "bg_raised";
  masterGrid.resizeColumn = !0;
  masterGrid.dragColumn = !0;
  pageRows.push(masterGrid);
  //    pageRows.push({view:"toolbar",css:"highlighted_header header6",paddingX:5,paddingY:5,height:40,cols:[{view:"pager",id:"pagerA-"+masterGrid.id,template:"{common.pages()}",autosize:!0,height:35,group:5}]});

  if (!masterGrid.on) masterGrid.on = {};
  var detailTabs = [];
  if (obj.detailGrids) {
    for (var i = 0; i < obj.detailGrids.length; i++) {
      var dgr = obj.detailGrids[i].grid;
      dgr.resizeColumn = !0;
      dgr.dragColumn = !0;
      var r = [];
      var but2 = prepareCrudButtons(dgr, dgr.pk || obj.detailGrids[i].pk);
      if (dgr.extraButtons) but2 = but2.concat(dgr.extraButtons);
      but2.push({});
      but2.push({
        view: "button",
        css: "button_danger",
        type: "iconButton",
        icon: "file-pdf-o",
        width: 120,
        label: "Export",
        idx: dgr.id,
        click: function(aq) {
          //					console.log(this);console.log(aq);
          webix.toExcel($$(this.config.idx));
        }
      });

      but2.push({
        view: "button",
        css: "button_danger",
        type: "iconButton",
        icon: "area-chart",
        width: 90,
        label: "BI",
        click: fncBI(dgr, true)
      });
      //			but2.push({}, { view:"button", type: "icon", icon: "wrench", value:"Info", width:30, align:"right" });

      r.push({
        type: "clean",
        padding: 5,
        id: "gt-" + dgr.id,
        height: 50, // css: "highlighted_header header5",
        cols: but2
      });
      dgr._masterGrid = masterGrid;
      r.push(dgr);
      detailTabs.push({
        id: "dt-" + dgr.id,
        header: dgr.name,
        minWidth: 250,
        body: { rows: r }
      }); //width:200,
    }

    masterGrid.on.onSelectChange = function() {
      var gr = $$(masterGrid.id);
      if (!gr) return;
      var sel = gr.getSelectedItem();
      for (var i = 0; i < obj.detailGrids.length; i++) {
        var dgr = $$(obj.detailGrids[i].grid.id);
        if (dgr) {
          dgr.clearAll();
          if (sel) {
            dgr._baseParams = buildParams2(obj.detailGrids[i].params, sel);
            //					if(dgr.isVisible()){ // TODO
            dgr.load(obj.detailGrids[i].grid._url + dgr._baseParams, {
              success: function() {
                console.log("success");
              },
              error: function() {
                console.log("error");
              }
            });
            //					}
          }
        }
      }
    };
  }

  if (detailTabs.length > 0) {
    pageRows.push({ view: "resizer" });
    pageRows.push({
      view: "tabview",
      css: "bg_raised",
      multiview: { animate: { type: "flip", subtype: "vertical" } },
      cells: detailTabs
    });
    masterGrid.height = masterGrid.defaultHeight;
  }

  if (masterGrid.pageSize > 0) masterGrid.loadahead = masterGrid.pageSize + 5;
  /*
	masterGrid.ready=function(){
		alert(2)
	    this.load(this._url);
	    this.select(this.getFirstId());
    }*/
  masterGrid.url = masterGrid._url;
  var graphOptions = [
    { id: 1, value: "<span class='webix_icon fa-bar-chart'></span>Çubuk" },
    { id: 3, value: "<span class='webix_icon fa-pie-chart'></span>Pasta" }
  ];
  if (masterGrid.$mapQueryField || masterGrid.$mapQueryFieldName)
    graphOptions.push({
      id: 9,
      value: "<span class='webix_icon fa-globe'></span>Harita"
    });
  var graphCombo = {
    view: "combo",
    id: "graph-" + masterGrid.id,
    value: 3,
    width: 200,
    options: graphOptions,
    placeholder: "Gösterim Şekli",
    on: {
      onChange: o => {
        if (1 * o != 9) webix.$$("group-" + masterGrid.id).show();
        else webix.$$("group-" + masterGrid.id).hide();
        makeGraph(masterGrid);
      }
    }
  };
  var aggFields = [],
    grpFields = [];
  masterGrid.columns.map(o => {
    var header = Array.isArray(o.header) ? o.header[0] : o.header;
    if (!header || !header.trim()) return;
    grpFields.push({ id: o.id, value: header });
    if (!o.sort || o.sort != "string") {
      if (header) aggFields.push({ id: o.id, value: header });
    }
  });
  var groupCombo = {
    view: "combo",
    id: "group-" + masterGrid.id,
    value: null,
    width: 200,
    options: grpFields,
    placeholder: "Gruplama Alanı",
    on: { onChange: o => makeGraph(masterGrid) }
  };

  if (true || masterGrid.$mapQueryField)
    pageRows = [
      {
        view: "segmented",
        id: "tabbar" + masterGrid.id,
        value: "idTableView" + masterGrid.id,
        multiview: true,
        hidden: true,
        options: [
          {
            value:
              "<span class='webix_icon fa-table'></span><span style='padding-left: 4px'>TABLO</span>",
            id: "idTableView" + masterGrid.id
          },
          {
            value:
              "<span class='webix_icon fa-globe'></span><span style='padding-left: 4px'>HARİTA</span>",
            id: "idMapView" + masterGrid.id
          }
        ]
      },
      {
        id: "mymultiview" + masterGrid.id,
        cells: [
          { id: "idTableView" + masterGrid.id, rows: pageRows },
          {
            id: "idMapView" + masterGrid.id,
            rows: [
              {
                type: "clean",
                height: 40,
                cols: [
                  {
                    view: "button",
                    css: "button_primary",
                    type: "iconButton",
                    icon: "backward",
                    label: "BACK",
                    width: 100,
                    click: function() {
                      webix
                        .$$("mymultiview" + masterGrid.id)
                        .setValue("idTableView" + masterGrid.id);
                    }
                  },
                  graphCombo,
                  groupCombo,
                  {},
                  {
                    view: "label",
                    align: "right",
                    width: 150,
                    label: "Aggregation"
                  },
                  {
                    view: "combo",
                    value: "10",
                    width: 120,
                    id: "aggr-" + masterGrid.id,
                    options: subMenus1,
                    on: {
                      onChange: o => {
                        if (1 * o > 10)
                          webix.$$("qfield-" + masterGrid.id).show();
                        else webix.$$("qfield-" + masterGrid.id).hide();
                        makeGraph(masterGrid);
                      }
                    }
                  },
                  {
                    view: "combo",
                    hidden: !0,
                    on: {
                      onChange: o => {
                        makeGraph(masterGrid);
                      }
                    },
                    placeholder: "İşlem Alanı",
                    value: null,
                    width: 200,
                    id: "qfield-" + masterGrid.id,
                    options: aggFields
                  }
                ]
              },
              {
                type: "clean",
                /*on:{onAfterRender:makeTRMap}, */ template:
                  '<div id="idxMap2' +
                  masterGrid.id +
                  '" style="background-color:#b5b5b5;width:100%;height:100%"></div>'
              }
            ]
          }
        ],
        on: {
          onViewChange: function(prevID, nextID) {
            if (nextID && nextID.indexOf("idMapView") == 0)
              makeGraph(masterGrid);
            else masterGrid._lastGraph = false;
          }
        }
      }
    ];
  return {
    id: obj.t,
    _lg: masterGrid.liveSync,
    type: "clean",
    header: masterGrid.name,
    close: true,
    minWidth: 180, //width:180,
    body: { type: "space", padding: 10, rows: pageRows }
  };
}

function makeGraph(_grid1) {
  if (
    !_grid1 ||
    $$("mymultiview" + _grid1.id)
      .getValue()
      .indexOf("idMapView") != 0
  )
    return;
  var tip = 1 * webix.$$("graph-" + _grid1.id).getValue();
  if (tip == 9) {
    makeTRMap(_grid1);
    return;
  }
  var stat = 1 * webix.$$("aggr-" + _grid1.id).getValue() - 10;
  var field = webix.$$("qfield-" + _grid1.id).getValue();
  var grpField = webix.$$("group-" + _grid1.id).getValue();
  if ((stat && !field) || !grpField) return;
  var currentGraph = tip + "-" + stat + "-" + field + "-" + grpField;
  if (!_grid1._lastGraph) {
    _grid1._lastGraph = currentGraph;
  } else {
    if (_grid1._lastGraph == currentGraph) return;
    _grid1._lastGraph = currentGraph;
  }

  function renderGraph(areaData) {
    var extraCfg = { depth3D: 30, angle: 30 };
    if (areaData.length < 50) extraCfg.startDuration = 1;
    if (tip == 3) {
      extraCfg.legend = {
        //
        position: "left"
      };
      AmCharts.makeChart(
        "idxMap2" + _grid1.id,
        iwb.apply(extraCfg, {
          type: "pie",
          labelRadius: 15,
          labelText: "[[value]]",
          innerRadius: "50%",
          dataProvider: areaData,
          balloonText: "[[title]]: [[percents]]%",
          valueField: "value",
          id: "[[dsc]]",
          titleField: "id",
          export: {
            enabled: true
          }
        })
      );
    } else {
      AmCharts.makeChart(
        "idxMap2" + _grid1.id,
        iwb.apply(extraCfg, {
          type: "serial",
          graphs: [
            {
              balloonText: "[[id]]: <b>[[value]]</b>",
              fillColorsField: "color",
              fillAlphas: 0.9,
              lineAlpha: 0.2,
              type: "column",
              valueField: "value",
              labelText: "[[value]]",
              lineThickness: null
            }
          ],
          valueAxes: [], //{"stackType": "regular"}
          chartCursor: {
            categoryBalloonEnabled: false,
            cursorAlpha: 0,
            zoomable: false
          },
          categoryField: "id",
          categoryAxis: {
            gridPosition: "start",
            labelRotation: 45
          },
          dataProvider: areaData,
          export: {
            enabled: true
          }
        })
      );
    }
  }

  var gx = $$(_grid1.id),
    grpMap = {},
    areaData = [];
  if (gx.getFilter && _grid1.$filterField) {
    var flt = gx.getFilter(_grid1.$filterField);
    if (flt) flt.setValue("");
  }
  var ds = gx.data;
  ds.each(o => {
    var il = o[grpField] || "";
    if (!grpMap[il]) {
      grpMap[il] = { cnt: 0, max: -999999, min: 99999, sum: 0 };
    }
    grpMap[il].cnt++;
    if (stat && field) {
      var n = 1 * o[field] || 0;
      grpMap[il].sum += n;
      if (grpMap[il].max < n) grpMap[il].max = n;
      if (grpMap[il].min > n) grpMap[il].min = n;
    }
  });
  for (var k in grpMap) {
    //0:count, 1:sum, 2.avg,3:max,4:min
    var val = 0;
    switch (stat) {
      case 0:
        val = grpMap[k].cnt;
        break;
      case 1:
        val = grpMap[k].sum;
        break;
      case 2:
        val = grpMap[k].cnt > 0 ? grpMap[k].sum / grpMap[k].cnt : 0;
        break;
      case 3:
        val = grpMap[k].min;
        break;
      case 4:
        val = grpMap[k].max;
        break;
    }
    areaData.push({
      id: k,
      value: val
    });
  }
  renderGraph(areaData);
}

var mapPopupGraphConfig = {};
function onPopupGraphTypeChange() {
  console.log(mapPopupGraphConfig);
  mapPopupGraphConfig.graphTip = document.getElementById("idGraphTypeX").value;
  iwb.graphAmchart(mapPopupGraphConfig, "idGraphX");
}

function makeTRMap(_grid1) {
  if (
    !_grid1 ||
    $$("mymultiview" + _grid1.id)
      .getValue()
      .indexOf("idMapView") != 0
  )
    return;
  var tip = 1 * webix.$$("graph-" + _grid1.id).getValue();
  if (tip < 9) {
    makeGraph(_grid1);
    return;
  }
  var stat = 1 * webix.$$("aggr-" + _grid1.id).getValue() - 10;
  var field = webix.$$("qfield-" + _grid1.id).getValue();
  if (stat && !field) return;
  var currentGraph = tip + "-" + stat + "-" + field;
  if (!_grid1._lastGraph) {
    _grid1._lastGraph = currentGraph;
  } else {
    if (_grid1._lastGraph == currentGraph) return;
    _grid1._lastGraph = currentGraph;
  }
  function renderMap(areaData) {
    AmCharts.makeChart("idxMap2" + _grid1.id, {
      type: "map",
      colorSteps: 25,
      dataProvider: {
        map: "turkeyLow",
        zoomLevel: 0.9,
        areas: areaData
      },
      areasSettings: {
        autoZoom: true,
        balloonText: "[[title]]: <strong>[[value]]</strong>",
        unlistedAreasAlpha: 0.9
      },
      valueLegend: {
        right: 10,
        minValue: "az",
        maxValue: "çok!"
      },
      zoomControl: {
        minZoomLevel: 0.9
      },
      titles: [{ text: _grid1.name, size: 16 }],
      listeners: [
        {
          event: "clickMapObject",
          method: function(e) {
            if (e.mapObject.objectType !== "MapArea") return;
            setTimeout(function() {
              if (_grid1.$mapGroupQueryField) {
                console.log("e", e);
                var xx = $$("idGraphPopup");
                if (xx) xx.close();
                xx = webix.ui({
                  view: "popup",
                  id: "idGraphPopup",
                  height: 500,
                  width: 800,
                  position: "center",
                  body: {
                    template:
                      "<div style='font-size:2rem'>" +
                      e.mapObject.enTitle +
                      "</div><select id='idGraphTypeX' style='float:right;margin-top:-35px' onchange='onPopupGraphTypeChange()'><option value=3 selected>pie</option><option value=1>bar</option></select><div id='idGraphX' style='width:100%;height:100%'></div>"
                  },
                  on: {
                    onShow: function() {
                      var params = {}; //alert($$('qfield-'+_grid1.id).getValue())
                      params["x" + _grid1.$filterField] = e.mapObject.id.substr(
                        3
                      );
                      mapPopupGraphConfig = {
                        graphId: 123,
                        name: "",
                        gridId: _grid1.gridId,
                        tableId: _grid1.crudTableId,
                        is3d: false,
                        dtTip: 3,
                        graphTip: document.getElementById("idGraphTypeX").value,
                        groupBy: _grid1.$mapGroupQueryField,
                        funcTip: $$("aggr-" + _grid1.id).getValue() - 10,
                        funcFields: _grid1.$mapFuncFields || "",
                        queryParams: params,
                        stackedFieldId: null,
                        legend: false
                      };
                      iwb.graphAmchart(mapPopupGraphConfig, "idGraphX");
                    }
                  }
                });
                xx.show(e.event, { pos: "center", x: 0, y: 0 });
              } else {
                $$("mymultiview" + _grid1.id).setValue(
                  "idTableView" + _grid1.id
                );
                if (_grid1.$dontClearFilter) return;
                var gx = $$(_grid1.id);
                if (gx.getFilter && _grid1.$filterField) {
                  var flt = gx.getFilter(_grid1.$filterField);
                  if (flt) flt.setValue("" + 1 * e.mapObject.id.substr(3));
                }
              }
            }, 1000);
          }
        }
      ]
    });
  }

  if (_grid1.$mapQueryFieldName) {
    var gx = $$(_grid1.id),
      ilMap = {},
      areaData = [];
    if (gx.getFilter && _grid1.$filterField) {
      var flt = gx.getFilter(_grid1.$filterField);
      if (flt) flt.setValue("");
    }
    var ds = gx.data;
    ds.each(o => {
      var il = o[_grid1.$mapQueryFieldName];
      if (il && 1 * il) {
        il = 1 * il;
        il = il > 9 ? "" + il : "0" + il;
        if (!ilMap[il]) {
          ilMap[il] = { cnt: 0, max: -999999, min: 99999, sum: 0 };
        }
        ilMap[il].cnt++;
        if (stat && field) {
          var n = 1 * o[field] || 0;
          ilMap[il].sum += n;
          if (ilMap[il].max < n) ilMap[il].max = n;
          if (ilMap[il].min > n) ilMap[il].min = n;
        }
      }
    });
    for (var k in ilMap) {
      //0:count, 1:sum, 2.avg,3:max,4:min
      var val = 0;
      switch (stat) {
        case 0:
          val = ilMap[k].cnt;
          break;
        case 1:
          val = ilMap[k].sum;
          break;
        case 2:
          val = ilMap[k].cnt > 0 ? ilMap[k].sum / ilMap[k].cnt : 0;
          break;
        case 3:
          val = ilMap[k].min;
          break;
        case 4:
          val = ilMap[k].max;
          break;
      }
      areaData.push({
        id: "TR-" + k,
        value: val
      });
    }
    renderMap(areaData);
    return;
  } else alert("Please set $mapQueryFieldName");
}

var addTab4GridWSearchForm = addTab4GridWSearchFormWithDetailGrids;

iwb.dateFormat = webix.Date.dateToStr("%d/%m/%Y %H:%i:%s");

function getValues(extDef, b) {
  var p = {};
  for (var k in extDef) {
    if (k && k.startsWith("_")) {
      var kk = $$(extDef[k].id);
      if (kk && kk.getValue) {
        var v = kk.getValue();
        if (webix.isDate(v)) v = iwb.dateFormat(v);
        p[k.substring(1)] = v;
      }
    }
  }
  if (b) p = iwb.apply(extDef.baseParams || {}, p);
  return p;
}

function getFormPk(f) {
  var s = "";
  if (f.a == 1) {
    for (var key in f.pk) if (key != "customizationId") s += "|" + f.pk[key];
  } else s = "|" + f.tmpId;
  return s.substr(1);
}

function submitAndApproveTableRecord() {
  alert("TODO 4 Webix");
}

function approveTableRecord(aa, frm) {
  var comment = prompt("Lütfen Açıklamayı Giriniz");
  if (!comment) {
    alert("Açıklama gerekli");
    return;
  }
  var prms = frm.pk;
  prms._arid = frm.approval.approvalRecordId;
  prms._aa = aa;
  prms._adsc = comment;
  prms._avno = frm.approval.versionNo;
  iwb.request({
    url: "ajaxApproveRecord",
    params: prms,
    successCallback: function(json) {
      alert(objProp(json));
    }
  });
}

function addTab4Form(formDef, callAttributes, _page_tab_id) {
  var extDef = formDef.render();
  //	console.log(extDef);console.log(formDef);
  var bar = [];
  if (!formDef.viewMode && (extDef.baseParams.sv_btn_visible || 1) == 1) {
    extDef.id = "tbv-" + formDef.id; //r.push({ view:"button", tooltip:'Yeni Kayıt', css:"	 button_raised",type:"iconButton", icon: "plus", label:"YENİ KAYIT", click: fnRowInsert(g, pk), width: 145});
    bar.push({
      view: "button",
      css: "button_raised",
      type: "iconButton",
      icon: "check",
      width: 105,
      label: "SAVE",
      click: function() {
        var p = getValues(extDef, true);
        p[".t="] = _page_tab_id;
        p[".w="] = _webPageId;
        webix.ajax().post("ajaxPostForm", p, function(text, xml, xhr) {
          var r = eval("(" + text + ")");
          if (r && r.success) {
            webix.message("Kaydedildi");
            if (r.msgs) webix.alert(r.msgs.join("<br/>"));
            mainPanel.removeTab();
          } else if (r && r.errorType == "validation") {
            var msg = '<b style="color:red">Doğrulama Hataları</b>';
            if (r.errors)
              for (var qi = 0; qi < r.errors.length; qi++) {
                msg +=
                  "<br/><li/>" +
                  r.errors[qi].dsc +
                  ": <b>" +
                  r.errors[qi].msg +
                  "</b>";
              }
            webix.alert(msg);
          }
        });
      }
    });
  }
  if (formDef.a == 1 && formDef.approval) {
    if (formDef.approval.wait4start) {
      bar.push({
        view: "button",
        css: "button_success button_raised",
        type: "iconButton",
        icon: "play-circle-o",
        width: 140,
        label: "ONAY İSTE",
        click: function() {
          approveTableRecord(901, formDef, formDef.approval.dynamic);
        }
      });
    } else {
      bar.push({
        view: "button",
        css: "button_success button_raised",
        type: "iconButton",
        icon: "forward",
        width: 140,
        label: "ONAYLA",
        click: function() {
          approveTableRecord(1, formDef);
        }
      });
      if (formDef.approval.returnFlag)
        bar.push({
          view: "button",
          css: "button_warning button_raised",
          type: "iconButton",
          icon: "backward",
          width: 140,
          label: "İADE ET",
          click: function() {
            approveTableRecord(2, formDef);
          }
        });
      bar.push({
        view: "button",
        css: "button_danger button_raised",
        type: "iconButton",
        icon: "stop",
        width: 130,
        label: "REDDET",
        click: function() {
          approveTableRecord(3, formDef);
        }
      });
      bar.push({
        view: "button",
        css: "button_primary",
        type: "iconButton",
        icon: "flag-o",
        width: 160,
        label: "ONAY LOGLARI",
        click: function() {
          approvalLog(formDef.approval.approvalRecordId);
        }
      });
    }
  }

  bar.push({
    view: "button",
    css: "button_primary",
    type: "iconButton",
    icon: "ban",
    width: 120,
    label: "CLOSE",
    click: function() {
      mainPanel.removeTab();
    }
  });
  bar.push({});
  if (formDef.fileAttachFlag)
    bar.push(
      formDef.fileAttachCount
        ? {
            view: "button",
            css:
              "button_primary" +
              (formDef.fileAttachCount ? "" : " button_raised"),
            type: "iconButton",
            icon: "upload",
            width: 190,
            label: "Dosyalar",
            badge: formDef.fileAttachCount,
            click: function() {
              return showFiles(formDef.crudTableId, getFormPk(formDef), this);
            }
          }
        : {
            view: "uploader",
            css: "button_primary button_raised",
            type: "iconButton",
            icon: "upload",
            width: 150,
            label: "File Upload",
            link: "fl-" + formDef.id,
            upload:
              "upload2.form?profilePictureFlag=0&table_id=" +
              formDef.crudTableId +
              "&table_pk=" +
              getFormPk(formDef)
          }
    );
  bar.push({
    view: "button",
    css: "button_warning button_raised",
    type: "iconButton",
    icon: "suitcase",
    width: 140,
    label: "Templates",
    click: function() {
      mainPanel.removeTab();
    }
  });
  extDef.css = "bg_raised";
  var rows = [{ height: 45, cols: bar }, extDef];
  if (formDef.fileAttachFlag)
    rows.push({
      view: "list",
      id: "fl-" + formDef.id,
      type: "uploader",
      autoheight: true,
      borderless: true
    });
  var p = {
    id: formDef.id,
    _l: formDef.liveSync,
    type: "clean",
    header:
      '<span class="webix_icon fa-' +
      (extDef.baseParams.a == 2 ? "plus" : "edit") +
      '"></span>' +
      formDef.name,
    close: true,
    minWidth: 180,
    body: { type: "wide", padding: 10, rows: rows }
  }; //width:180,
  //	if(extDef._onReady)p._onReady=extDef._onReady;

  return p;
}

iwb.ui.buildCRUDForm = addTab4Form;

function promisLoadException(e) {
  //	console.log(e);
  webix.alert("ERROR:promisLoadException\n" + objProp(e));
}

function promisLoadException2(e, x, w) {
  console.log(e);
  console.log(x);
  webix.alert("Load ERROR:promisLoadException2");
}
var wndLogin = null;
function loginDlg() {
  if (wndLogin && wndLogin.isVisible()) return;
  if (!wndLogin)
    wndLogin = webix.ui({
      view: "window",
      height: 250,
      head: "Session Expired",
      width: 300,
      position: "center",
      modal: true,
      body: {
        view: "form",
        width: 300,
        elements: [
          {
            view: "text",
            label: "User Name",
            value: _scd.userName,
            readonly: true
          },
          {
            view: "text",
            id: "idLoginPassWord",
            type: "password",
            label: "Password"
          },
          {
            margin: 5,
            cols: [
              {
                view: "button",
                value: "Login",
                type: "form",
                click: function() {
                  var ps = $$("idLoginPassWord").getValue();
                  $$("idLoginPassWord").setValue("");
                  if (ps) {
                    webix.ajax().post(
                      "ajaxAuthenticateUser",
                      {
                        userRoleId: _scd.userRoleId,
                        locale: _scd.locale,
                        customizationId: 0,
                        userName: _scd.userName,
                        passWord: ps
                      },
                      function(text, xml, xhr) {
                        var r = eval("(" + text + ")");
                        if (r && r.success) {
                          if (r.session) _scd = r.session;
                          wndLogin.hide();
                        } else {
                          webix.message(r.errorMsg || r.error);
                        }
                      }
                    );
                  }
                }
              },
              {
                view: "button",
                value: "Vazgeç",
                click: function() {
                  document.location = "login.htm";
                }
              }
            ]
          }
        ]
      }
    });
  wndLogin.show();
}

function ajaxErrorHandler(e) {
  if (e && e.errorType)
    switch (e.errorType) {
      case "session":
        loginDlg();
        break;
      case "sql": //scripting
        webix.alert("Scripting ERROR: <b>" + e.error + "</b>");
        break;
      case "security": //scripting
        webix.alert("Security ERROR: <b>" + e.error + "</b>");
        break;
      case "framework": //scripting
        webix.alert("Framework ERROR: <b>" + e.error + "</b>");
        break;
      case "validation": //validation
        webix.alert("Validation ERROR: <b>" + e.error + "</b>");
        break;
      default:
        webix.alert("Unknown ERROR: <b>" + e.error + "</b>");
        break;
    }
  else webix.alert("no connection");
}

function gridQwRendererWithLink(field, tbl_id) {
  return function(c) {
    return c[field] != undefined
      ? '<a href=# onclick="return fnTblRecEdit(' +
          tbl_id +
          "," +
          c[field] +
          ')">' +
          c[field + "_qw_"] +
          "</a>"
      : "";
  };
}

function gridUserRenderer(field) {
  return function(c) {
    return c[field] == _scd.userId
      ? c[field + "_qw_"]
      : '<a href=# onclick="return openChatWindow(' +
          c[field] +
          ",'" +
          c[field + "_qw_"] +
          "',true)\">" +
          c[field + "_qw_"] +
          "</a>";
  };
}

function approvalLog(r, z) {
  var rows = [];
  if (false && z) {
    var bar = [];
    bar.push({
      view: "button",
      css: "button_success button_raised",
      type: "iconButton",
      icon: "forward",
      width: 140,
      label: "ONAYLA",
      click: function() {
        alert("TODO");
      }
    });
    bar.push({
      view: "button",
      css: "button_danger button_raised",
      type: "iconButton",
      icon: "stop",
      width: 140,
      label: "REDDET",
      click: function() {
        alert("TODO");
      }
    });
    bar.push({});
    rows.push({ cols: bar });
    rows.push({ height: 1, css: { "background-color": "lightgray" } });
  }
  rows.push({
    view: "list",
    autoheight: !0,
    css: "chat_list",
    maxHeight: 500,
    position: z ? undefined : "center",
    url: "ajaxQueryData?_qid=624&_renderer=webix3_3&xapproval_record_id=" + r,
    type: {
      height: 54,
      template: function(obj) {
        //				var text = "Sed ut perspiciatis unde omnis iste natus error sit voluptatem accusantium doloremque laudantium, totam rem aperiam, eaque ipsa quae ab illo inventore veritatis et quasi architecto beatae. ";
        var html = "<img class='photo' src='sf/pic" + obj.user_id + ".png' />";
        html +=
          "<div class='text'><div class='name'>" +
          obj.user_id_qw_ +
          "<div class='time'><b>" +
          obj.approval_action_tip_qw_ +
          "</b> " +
          obj.log_dttm +
          "</div></div>";
        html += (obj.dsc || "...") + "</div>";
        return html;
      }
    }
  });
  var ee = webix.ui({
    view: "popup",
    width: 500,
    position: z ? undefined : "center",
    padding: 0,
    //		css: "list_popup",
    body: {
      type: "clean",
      borderless: !0,
      rows: rows
    }
  });
  if (z) ee.show(z);
  else ee.show();
  return false;
}

function approvalHtml(x, y, z) {
  if (!x) return "";
  if (!z || !z.data) return "";
  z = z.data;
  var str =
    '<a href=# onclick="return approvalLog(' + z.pkpkpk_arf_id + ',this)"';
  if (z.app_role_ids_qw_ || z.app_user_ids_qw_) {
    str += ' title="Approval By'; //+getLocMsg('js_onaylayacaklar');
    var bb = false;
    if (z.app_role_ids_qw_) {
      str += " [Roles: " + z.app_role_ids_qw_ + "]";
      bb = true;
    }
    if (z.app_user_ids_qw_) {
      if (bb) str += ",";
      str += " [Users: " + z.app_user_ids_qw_ + "]";
    }
    str += '"';
  }
  str += ">";
  if (x > 0)
    str +=
      '<span style="color:red;padding:0;" class="webix_icon fa-flag-o"></span>';
  str += z.pkpkpk_arf_qw_ + "</a>";
  return str;
}

function buildParams(params, map) {
  var bp = {};
  for (var key in params) {
    var newKey = params[key];
    if (typeof newKey == "function") {
      bp[key] = newKey(params);
    } else if (newKey.charAt(0) == "!") bp[key] = newKey.substring(1);
    else bp[key] = map[params[key]];
  }
  return bp;
}

function gcx(w, h, r) {
  var l = (screen.width - w) / 2;
  var t = (screen.height - h) / 2;
  r = r ? 1 : 0;
  return (
    "toolbar=0,scrollbars=0,location=0,status=1,menubar=0,resizable=" +
    r +
    ",width=" +
    w +
    ",height=" +
    h +
    ",left=" +
    l +
    ",top=" +
    t
  );
}

iwb.openPopup = function(url, name, x, y, r) {
  var wh = window.open(url, name, gcx(x, y, r));
  if (!wh) webix.alert(getLocMsg("js_once_popup_engel_kaldir"));
  else wh.focus();
  return false;
};

iwb.apply = function(o, c, defaults) {
  if (defaults) {
    iwb.apply(o, defaults);
  }
  if (o && c && typeof c == "object") {
    for (var p in c) {
      o[p] = c[p];
    }
  }
  return o;
};

iwb.map2str = function(m) {
  if (!m) return "";
  var s = "";
  for (var k in m) s += "&" + k + "=" + m[k];
  return s.substring(1);
};

iwb.combo2combo = function(s, d, p) {
  //	console.log(s);console.log(d);console.log(p);
  if (
    typeof s.hiddenValue != "undefined" ||
    typeof d.hiddenValue != "undefined"
  ) {
    webix.alert("TODO combo2combo");
    return;
  }
  var dd = $$(d.id);
  //	console.log(dd);
  var ss = $$(s.id);
  ss.attachEvent("onChange", function(newv, oldv) {
    if (dd.getPopup() && dd.getPopup().getList()) {
      dd.setValue("");
      var zz = dd.getPopup().getList();
      zz.clearAll();
      zz.load("ajaxQueryData?" + iwb.map2str(p(newv)) + "&_renderer=webix3_3");
    }
  });
  if (ss.getValue() && dd.getPopup() && dd.getPopup().getList()) {
    var zz = dd.getPopup().getList();
    zz.clearAll();
    zz.load(
      "ajaxQueryData?" + iwb.map2str(p(ss.getValue())) + "&_renderer=webix3_3"
    );
  }
};

iwb.loadCombo = function(s, p, formAction) {
  if (typeof s == "undefined" || !p) return;
  if (typeof s.hiddenValue != "undefined") {
    if (s._controlTip == 101) {
      /*	promisRequest({url:'ajaxQueryData',params:param,successCallback:function(j2){
				if(j2 && j2.data && j2.data.length)for(var qi=0;qi<j2.data.length;qi++)if(''+j2.data[qi].id==''+comboMaster.hiddenValue){
					comboMaster.setValue('<b>'+j2.data[qi].dsc+'</b>');
				}
			}});*/
    }
    return;
  }
  var ss = $$(s.id);
  var url = "ajaxQueryData?" + iwb.map2str(p) + "&_renderer=webix3_3";
  if (ss) {
    if (ss) ss.load(url);
  } else {
    s.on = {
      onAfterRender: function(a, b, c) {
        if (this.getPopup() && this.getPopup().getList()) {
          this.getPopup()
            .getList()
            .load(url);
        }
      }
    };
  }
};

//deprecated functions 4 backward compatibility
var loadCombo = iwb.loadCombo;
var combo2combo = iwb.combo2combo;
var openPopup = iwb.openPopup;

function buildPanel(obj, isMasterFlag) {
  if (!obj) return false;
  if (obj.grid) {
    if (obj.detailGrids)
      return addTab4GridWSearchFormWithDetailGrids(obj, isMasterFlag);
    else return addTab4GridWSearchForm(obj);
  } else if (obj.detailGrids) return addTab4DetailGridsWSearchForm(obj);
  else return false;
}
iwb.ui.buildPanel = buildPanel;

function startCompare(value, filter) {
  value = value.toString();
  filter = filter.toString();

  return value.indexOf(filter) === 0;
}

iwb.dashboard = function(dg, gid) {
  //	var dg=aq._dg, gid=aq._gid;
  var newStat = 1 * dg.funcTip ? dg.funcFields : "";
  var params = {};
  if (newStat) params._ffids = newStat;
  if (1 * dg.graphTip >= 5) params._sfid = dg.stackedFieldId;
  iwb.request({
    url:
      "ajaxQueryData4StatTree?_gid=" +
      dg.gridId +
      "&_stat=" +
      dg.funcTip +
      "&_qfid=" +
      dg.groupBy +
      "&_dtt=" +
      dg.dtTip,
    params: iwb.apply(params, dg.queryParams),
    successCallback: function(az) {
      if (!az.data) az.data = [];
      var resc = 1;
      if (1 * dg.graphTip < 5) {
        if (newStat.indexOf(",") > 0) {
          resc = newStat.split(",").length;
          if (resc > 4) resc = 4;
          for (var qi = 0; qi < az.data.length; qi++) {
            az.data[qi].xres = Math.round(1 * (az.data[qi].xres || 0));
            for (var zi = 2; zi <= resc; zi++) {
              az.data[qi]["xres" + zi] = Math.round(
                1 * (az.data[qi]["xres" + zi] || 0)
              );
            }
          }
        } else {
          var colors = [
            "#FF0F00",
            "#FF6600",
            "#FF9E01",
            "#FCD202",
            "#F8FF01",
            "#B0DE09",
            "#04D215",
            "#0D8ECF",
            "#0D52D1",
            "#2A0CD0",
            "#8A0CCF",
            "#CD0D74"
          ];
          for (var qi = 0; qi < az.data.length; qi++) {
            az.data[qi].xres = Math.round(1 * (az.data[qi].xres || 0));
            az.data[qi].color = colors[qi % colors.length];
          }
        }
      } else {
        for (var ki in az.lookUp) {
          if (1 * dg.graphTip == 6)
            for (var qi = 0; qi < az.data.length; qi++) {
              az.data[qi]["xres_" + ki] = Math.round(
                1 * (az.data[qi]["xres_" + ki] || 0)
              );
            }
          if (!az.lookUp[ki]) az.lookUp[ki] = "*" + ki;
        }
      }
      var extraCfg =
        dg.is3d && 1 * dg.graphTip < 6 ? { depth3D: 20, angle: 30 } : {};
      switch (1 * dg.graphTip) {
        case 6: //stacked area
          var graphs = [];
          for (var k in az.lookUp)
            graphs.push({
              balloonText: "<b>" + az.lookUp[k] + ": [[xres_" + k + "]]</b>",
              fillAlphas: 0.6,
              lineAlpha: 0.2,
              color: "#000000",
              title: az.lookUp[k],
              valueField: "xres_" + k
            });
          if (dg.legend)
            extraCfg.legend = {
              equalWidths: false,
              periodValueText: "total: [[value.sum]]",
              position: "top",
              valueAlign: "left",
              valueWidth: 100
            };
          AmCharts.makeChart(
            gid,
            iwb.apply(extraCfg, {
              type: "serial",
              graphs: graphs,
              valueAxes: [
                {
                  stackType: "regular",
                  axisAlpha: 0.3,
                  gridAlpha: 0.2
                }
              ],
              chartCursor: {
                categoryBalloonEnabled: false,
                cursorAlpha: 0,
                zoomable: false
              },
              categoryField: "dsc",
              categoryAxis: {
                labelRotation: 45,
                gridPosition: "start",
                axisAlpha: 0,
                gridAlpha: 0,
                position: "left"
              },
              dataProvider: az.data
            })
          );

          break;

        case 5: //stacked column
          var graphs = [];
          for (var k in az.lookUp)
            graphs.push({
              balloonText: "<b>" + az.lookUp[k] + ": [[xres_" + k + "]]</b>",
              fillAlphas: 0.9,
              lineAlpha: 0.2,
              type: "column",
              color: "#000000",
              title: az.lookUp[k],
              valueField: "xres_" + k
            });
          if (dg.legend)
            extraCfg.legend = {
              equalWidths: false,
              periodValueText: "total: [[value.sum]]",
              position: "top",
              valueAlign: "left",
              valueWidth: 100
            };
          AmCharts.makeChart(
            gid,
            iwb.apply(extraCfg, {
              type: "serial",
              graphs: graphs,
              valueAxes: [
                {
                  stackType: "regular",
                  axisAlpha: 0.3,
                  gridAlpha: 0.2
                }
              ],
              chartCursor: {
                categoryBalloonEnabled: false,
                cursorAlpha: 0,
                zoomable: false
              },
              categoryField: "dsc",
              categoryAxis: {
                labelRotation: 45,
                gridPosition: "start",
                axisAlpha: 0,
                gridAlpha: 0,
                position: "left"
              },
              dataProvider: az.data
            })
          );

          break;

        case 3:
          if (dg.legend) extraCfg.legend = { position: "left" };
          AmCharts.makeChart(
            gid,
            iwb.apply(extraCfg, {
              type: "pie",
              startDuration: 2,
              labelRadius: 15,
              labelText: dg.legend ? "[[percents]]%" : "[[dsc]]: [[value]]",
              innerRadius: "50%",

              //							     "legend":{"position":"left"}, //","marginRight":100,"autoMargins":false
              dataProvider: az.data,
              balloonText: "[[dsc]]: [[value]]",
              valueField: "xres",
              titleField: "dsc"
            })
          );
          break;
        case 1:
          if (resc > 1) {
            //pek cok var
            var qq = newStat.split(",");
            var graphs = [
              {
                balloonText:
                  "<b>" +
                  "TODO" /*mf._func_query_field_ids.store.getById(qq[0].split('=')[1]).get('dsc')*/ +
                  ": [[xres]]</b>",
                fillAlphas: 0.9,
                lineAlpha: 0.2,
                type: "column",
                valueField: "xres"
              }
            ];
            for (var zi = 2; zi <= resc; zi++)
              graphs.push({
                balloonText:
                  "<b>" +
                  "TODO" /*mf._func_query_field_ids.store.getById(qq[zi-1]).get('dsc')*/ +
                  ": [[xres" +
                  zi +
                  "]]</b>",
                fillAlphas: 0.9,
                lineAlpha: 0.2,
                type: "column",
                valueField: "xres" + zi
              });
            AmCharts.makeChart(
              gid,
              iwb.apply(extraCfg, {
                type: "serial",
                startDuration: 2,
                graphs: graphs,
                chartCursor: {
                  categoryBalloonEnabled: false,
                  cursorAlpha: 0,
                  zoomable: false
                },
                categoryField: "dsc",
                categoryAxis: {
                  gridPosition: "start",
                  labelRotation: 45
                },
                dataProvider: az.data
              })
            );
          } else
            AmCharts.makeChart(
              gid,
              iwb.apply(extraCfg, {
                type: "serial",
                startDuration: 2,
                graphs: [
                  {
                    balloonText: "<b>[[dsc]]: [[xres]]</b>",
                    fillColorsField: "color",
                    fillAlphas: 0.9,
                    lineAlpha: 0.2,
                    type: "column",
                    valueField: "xres"
                  }
                ],
                chartCursor: {
                  categoryBalloonEnabled: false,
                  cursorAlpha: 0,
                  zoomable: false
                },
                categoryField: "dsc",
                categoryAxis: {
                  gridPosition: "start",
                  labelRotation: 45
                },
                dataProvider: az.data
              })
            );
          break;
      }
    }
  });
};

webix.protoUI(
  {
    name: "combo-dt-suggest",
    getItemText: function(a) {
      if (!a) return "";
      var l = this.getList();
      if (!l || !l.getItem || !l.getItem(a)) return "";
      return l.getItem(a).value;
    },
    getList: function() {
      var b = this.getBody();
      if (!b || !b.getChildViews() || !b.getChildViews().length) return null;
      return b.getChildViews()[0];
    }
  },
  webix.ui.suggest
);

iwb.ajax={}
iwb.ajax.query=function(qid,params,callback){
	iwb.request({url:'ajaxQueryData?_qid='+qid,params:params||{},successCallback:callback||false})
}
iwb.ajax.postForm=function(fid,action,params,callback){
	iwb.request({url:'ajaxPostForm?_fid='+fid+'&a='+action,params:params||{},successCallback:callback||false})
}
iwb.ajax.execFunc=function(did,params,callback){
	iwb.request({url:'ajaxExecDbFunc?_did='+did,params:params||{},successCallback:callback||false})
}